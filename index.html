<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Cafe POS — Mobile Friendly</title>
  <style>
    :root {
      --bg: #0f1720;
      --card: #122433;
      --accent: #66c0f4;
      --muted: #cfe9ff;
      --danger: #ff5a5f;
      --ok: #3ddc84;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: var(--bg);
      color: #fff;
      -webkit-font-smoothing: antialiased;
    }

    header {
      padding: 14px 14px 6px;
      display: flex;
      align-items: center;
      gap: 12px
    }

    header h1 {
      font-size: 18px;
      margin: 0;
      font-weight: 700
    }

    .container {
      padding: 12px;
      max-width: 1300px;
      margin: 0 auto
    }

    .grid {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr
    }

    @media(min-width:900px) {
      .grid {
        grid-template-columns: 180px 420px 1fr;
        align-items: start
      }
    }

    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .35)
    }

    .left-controls {
      display: flex;
      flex-direction: column;
      gap: 10px
    }

    .search {
      flex: 1;
      display: flex;
      gap: 8px
    }

    .search input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: none;
      font-size: 15px;
      background: rgba(255, 255, 255, 0.02);
      color: #fff
    }

    .cat-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px
    }

    .cat {
      padding: 6px 8px;
      border-radius: 999px;
      font-size: 13px;
      background: rgba(255, 255, 255, 0.03);
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.03)
    }

    .cat.active {
      background: var(--accent);
      color: #072033;
      font-weight: 700;
      border: none
    }

    .menu-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 8px;
      margin-top: 10px
    }

    .menu-item {
      padding: 10px;
      border-radius: 10px;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.03);
      font-size: 14px;
      text-align: center;
      cursor: pointer
    }

    .menu-item .name {
      font-weight: 600
    }

    .menu-item .price {
      font-size: 13px;
      color: var(--muted)
    }

    .menu-item.clicked {
      transform: scale(0.985);
      opacity: 0.7;
      transition: transform 120ms ease, opacity 120ms ease
    }

    .qty-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      align-items: center
    }

    .qty-row button {
      padding: 8px 10px;
      border-radius: 8px;
      border: none;
      background: rgba(255, 255, 255, 0.03);
      color: #fff
    }

    .cust-select {
      width: 100%;
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      background: var(--card);
      color: #fff;
      font-size: 14px;
      -webkit-appearance: none;
      appearance: none;
      padding-right: 36px;
      border: 1px solid rgba(255, 255, 255, 0.03);
    }

    .cust-select option {
      background: var(--card);
      color: #fff;
    }

    .cust-select::-ms-expand {
      display: none;
    }

    .quick-list {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .quick-btn {
      padding: 8px 10px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.03);
      cursor: pointer;
      color: #fff;
      font-weight: 700;
      transition: box-shadow .12s ease, border-color .12s ease, transform .08s ease;
    }

    .quick-btn.active {
      border: 2px solid var(--accent);
      box-shadow: 0 6px 20px rgba(102, 192, 244, 0.18);
      background: rgba(102, 192, 244, 0.06);
      color: #072033;
    }

    .quick-btn:hover {
      transform: translateY(-2px);
    }

    .orders {
      max-height: 60vh;
      overflow: auto;
      padding-right: 6px
    }

    .order-card {
      padding: 10px;
      border-radius: 8px;
      display: flex;
      gap: 8px;
      align-items: flex-start;
      justify-content: space-between;
      border: 1px solid rgba(255, 255, 255, 0.03);
      margin-bottom: 8px;
      background: transparent
    }

    .order-meta {
      font-size: 12px;
      color: var(--muted)
    }

    .items {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 8px
    }

    .item-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 8px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.12);
      font-size: 14px;
      cursor: pointer
    }

    .item-row.paid {
      text-decoration: line-through;
      opacity: .6;
      background: transparent
    }

    .checkout {
      position: sticky;
      bottom: 0;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.6));
      padding-top: 8px
    }

    .checkout-inner {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      border-radius: 10px
    }

    .badge-due {
      background: var(--danger);
      padding: 6px 10px;
      border-radius: 8px;
      font-weight: 700;
      color: #fff
    }

    .btn {
      padding: 10px 12px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 700
    }

    .btn.primary {
      background: var(--accent);
      color: #072033
    }

    .btn.ghost {
      background: rgba(255, 255, 255, 0.03);
      color: #fff
    }

    .btn.small {
      padding: 8px 10px;
      font-size: 13px
    }

    .muted {
      color: var(--muted);
      font-size: 13px
    }

    @media(max-width:420px) {
      .menu-list {
        grid-template-columns: repeat(2, 1fr)
      }
    }

    @media(min-width:900px) {
      .menu-list {
        grid-template-columns: repeat(3, 1fr)
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>☕ Cafe POS — Mobile</h1>
  </header>

  <div class="container">
    <div class="grid">

      <!-- LEFT column: qty + customers (dropdown + quick buttons) -->
      <div class="card left-controls">
        <div style="font-weight:700;margin-bottom:6px">Quick controls</div>

        <div style="display:flex;justify-content:center;align-items:center;gap:8px;">
          <button onclick="adjustQty(-1)" class="btn small">−</button>
          <input id="qtySidebar" type="number" min="1" value="1"
            style="width:72px;padding:8px;border-radius:8px;border:none;text-align:center;background:rgba(255,255,255,0.02);color:#fff" />
          <button onclick="adjustQty(1)" class="btn small">+</button>
        </div>

        <!-- Dropdown for selecting any existing customer quickly -->
        <div style="margin-top:10px;">
          <select id="customerDropdown" class="cust-select" onchange="selectCustomerFromDropdown()">
            <option value="">— Select customer —</option>
          </select>
        </div>

        <!-- Quick buttons for frequent/repeated customers -->
        <div style="margin-top:8px; font-size:13px; color:var(--muted)">Quick access</div>
        <div class="quick-list">
          <button class="quick-btn" data-name="GG" onclick="quickCustomer('GG')">GG</button>
          <button class="quick-btn" data-name="Vashisht" onclick="quickCustomer('Vashisht')">Vashisht</button>
          <button class="quick-btn" data-name="Meet" onclick="quickCustomer('Meet')">Meet</button>
          <button class="quick-btn" data-name="Digvijay" onclick="quickCustomer('Digvijay')">Digvijay</button>
          <button class="quick-btn" data-name="Ishant" onclick="quickCustomer('Ishant')">Ishant</button>
          <button class="quick-btn" data-name="Ineco" onclick="quickCustomer('Ineco')">Ineco</button>
          <button class="quick-btn" data-name="Dhawal" onclick="quickCustomer('Dhawal')">Dhawal</button>
        </div>

        <div style="margin-top:8px;text-align:center;">
          <button class="btn primary small" onclick="createCustomerPrompt()">+ New Customer</button>
        </div>
      </div>

      <!-- MIDDLE column: menu -->
      <div class="card">
        <div style="display:flex;gap:8px;align-items:center;">
          <div style="flex:1">
            <div style="display:flex;gap:6px;align-items:center;">
              <div class="search"><input id="searchBox" placeholder="Search items or category" /></div>
              <button class="btn ghost small" onclick="clearSearch()">Clear</button>
            </div>
            <div class="cat-row" id="categoryRow"></div>
          </div>
        </div>

        <div id="menuList" class="menu-list"></div>

        <div style="margin-top:8px" class="muted">Tap an item to add it to the active customer. Use the quantity
          selector in the left column.</div>
      </div>

      <!-- RIGHT column: orders -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <strong>Orders</strong>
            <div class="muted" id="ordersHint">Tap any item to toggle paid/unpaid</div>
          </div>
          <div style="display:flex;gap:8px;">
            <button class="btn ghost small" onclick="openVisualizer()">Reports</button>
            <button class="btn ghost small" onclick="uploadPending(true)">Upload Now</button>
            <button class="btn ghost small" onclick="downloadSalesCSV()">Download CSV</button>
            <button class="btn ghost small" onclick="downloadSalesXLSX()">Download Excel</button>
          </div>
        </div>

        <div class="orders" id="ordersContainer" style="margin-top:8px;"></div>
        <div style="margin-top:8px" class="muted" id="pendingSummary"></div>
      </div>

    </div>
  </div>

  <div class="checkout">
    <div class="container">
      <div class="card checkout-inner" style="display:flex;align-items:center;">
        <div style="display:flex;gap:10px;align-items:center;">
          <div style="min-width:160px">
            <div class="muted">Active</div>
            <div id="activeCustomerLabel" style="font-weight:800">—</div>
            <div class="muted" id="activeCustomerId" style="font-size:12px"></div>
          </div>

          <div class="totals">
            <div class="muted">Due</div>
            <div id="dueBadge" class="badge-due">₹0</div>
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;">
          <button class="btn ghost small" onclick="markAllToggle()">Mark All</button>
          <button class="btn primary" onclick="quickAdd()">Add</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * MENU and DATA
     ***********************/
    const MENU = [
      { name: "Tea", price: 10, category: "Beverages" },
      { name: "Small Tea", price: 7, category: "Beverages" },
      { name: "Masala tea", price: 15, category: "Beverages" },
      { name: "Kulhad Chai", price: 20, category: "Beverages" },
      { name: "Lemon tea", price: 20, category: "Beverages" },
      { name: "Coffee", price: 20, category: "Beverages" },
      { name: "Kulhad Coffee", price: 30, category: "Beverages" },
      { name: "Cold Coffee", price: 60, category: "Beverages" },
      { name: "Cold Coffee with ice-cream", price: 80, category: "Beverages" },

      { name: "Water bottle 1 litre", price: 20, category: "Beverages" },
      { name: "Small water bottle", price: 10, category: "Beverages" },

      { name: "Plain maggi", price: 40, category: "Snacks" },
      { name: "Veg maggi", price: 60, category: "Snacks" },
      { name: "Veg Cheese maggi", price: 80, category: "Snacks" },
      { name: "Veg grilled sandwich", price: 80, category: "Snacks" },
      { name: "Panner sandwich", price: 120, category: "Snacks" },
      { name: "Cheese sandwich", price: 80, category: "Snacks" },
      { name: "Red sauce pasta", price: 80, category: "Snacks" },
      { name: "White sauce pasta", price: 120, category: "Snacks" },
      { name: "Margherita pizza", price: 80, category: "Snacks" },
      { name: "Veg delight pizza", price: 110, category: "Snacks" },
      { name: "Panner pizza", price: 130, category: "Snacks" },
      { name: "Sweet corn Pizza", price: 80, category: "Snacks" },

      { name: "Burger", price: 50, category: "Snacks" },
      { name: "French Fries", price: 60, category: "Snacks" },
      { name: "Maska bun", price: 30, category: "Snacks" },

      { name: "Burger + French Fries + Cold Coffee", price: 170, category: "Combos" },
      { name: "Burger + Cold Coffee", price: 100, category: "Combos" },
      { name: "Veg grilled sandwich + Cold Coffee", price: 120, category: "Combos" },
      { name: "Margherita pizza + Cold Coffee", price: 120, category: "Combos" },
      { name: "Red sauce pasta + Cold Coffee", price: 120, category: "Combos" },
      { name: "Kulhad chai + Maska bun", price: 40, category: "Combos" },

      { name: "Extra cheese", price: 20, category: "Extras" },

      { name: "Cig (20)", price: 20, category: "Cigarettes" },
      { name: "Cig (12)", price: 12, category: "Cigarettes" },
      { name: "Cig (10)", price: 10, category: "Cigarettes" },
      { name: "Cig (7)", price: 7, category: "Cigarettes" }
    ];

    /***********************
     * storage keys + helpers
     ***********************/
    const KEY_ORDERS = 'cafe_orders_v1';
    const KEY_PENDING = 'cafe_pending_batches_v1';

    function readJSON(k, fallback) { try { const s = localStorage.getItem(k); return s ? JSON.parse(s) : fallback; } catch (e) { return fallback; } }
    function writeJSON(k, v) { localStorage.setItem(k, JSON.stringify(v)); }

    function genId(prefix = 'C') { const now = Date.now(); return prefix + '-' + now + '-' + Math.floor(Math.random() * 900 + 100); }

    let customers = readJSON(KEY_ORDERS, []);
    let pendingBatches = readJSON(KEY_PENDING, []);
    let activeCustomerId = customers.length ? customers[0].id : null;

    /***********************
     * UI refs
     ***********************/
    const menuListEl = document.getElementById('menuList');
    const categoryRow = document.getElementById('categoryRow');
    const searchBox = document.getElementById('searchBox');
    const qtySidebar = document.getElementById('qtySidebar');
    const customerDropdown = document.getElementById('customerDropdown');
    const ordersContainer = document.getElementById('ordersContainer');
    const activeCustomerLabel = document.getElementById('activeCustomerLabel');
    const activeCustomerIdLabel = document.getElementById('activeCustomerId');
    const dueBadge = document.getElementById('dueBadge');
    const pendingSummary = document.getElementById('pendingSummary');

    /***********************
     * categories
     ***********************/
    const categories = Array.from(new Set(MENU.map(m => m.category || 'General')));
    let activeCategory = null;
    function renderCategories() {
      categoryRow.innerHTML = '';
      const allBtn = document.createElement('div'); allBtn.className = 'cat' + (activeCategory === null ? ' active' : ''); allBtn.textContent = 'All';
      allBtn.onclick = () => { activeCategory = null; renderCategories(); renderMenu(); };
      categoryRow.appendChild(allBtn);
      categories.forEach(cat => {
        const el = document.createElement('div'); el.className = 'cat' + (activeCategory === cat ? ' active' : ''); el.textContent = cat;
        el.onclick = () => { activeCategory = cat; renderCategories(); renderMenu(); }; categoryRow.appendChild(el);
      });
    }

    /***********************
     * render menu (single-click uses left qty)
     ***********************/
    function renderMenu() {
      const q = (searchBox.value || '').trim().toLowerCase();
      menuListEl.innerHTML = '';
      const filtered = MENU.filter(it => {
        if (activeCategory && it.category !== activeCategory) return false;
        if (!q) return true;
        return (it.name + ' ' + (it.category || '')).toLowerCase().includes(q);
      });

      filtered.forEach(it => {
        const div = document.createElement('div'); div.className = 'menu-item';
        div.innerHTML = `<div class="name">${it.name}</div><div class="price">₹${it.price}</div>`;

        div.onclick = () => {
          div.classList.add('clicked'); setTimeout(() => div.classList.remove('clicked'), 150);
          const qty = Math.max(1, Number(qtySidebar.value || 1));
          addItemToActive(it, qty);
          qtySidebar.value = 1; // reset after add
        };

        menuListEl.appendChild(div);
      });

      if (filtered.length === 0) {
        const n = document.createElement('div'); n.className = 'muted'; n.style.padding = '10px'; n.textContent = 'No items found';
        menuListEl.appendChild(n);
      }
    }
    searchBox.addEventListener('input', () => renderMenu());
    function clearSearch() { searchBox.value = ''; renderMenu(); }

    /***********************
     * customers & numbering
     ***********************/
    function createCustomer(name) {
      let counter = Number(localStorage.getItem('cafe_customer_counter_v1') || 0);
      counter = counter + 1;
      localStorage.setItem('cafe_customer_counter_v1', String(counter));
      const defaultName = `Customer ${counter}`;
      const finalName = (name && name.toString().trim()) ? name.toString().trim() : defaultName;
      const id = genId();
      const c = { id, name: finalName, createdAt: new Date().toISOString(), items: [], adjustments: [], uploaded: false };
      customers.unshift(c);
      activeCustomerId = id;
      persistAndRender();
      return c;
    }
    function createCustomerPrompt() {
      const name = prompt('Customer name (leave blank for auto):', '');
      createCustomer(name || null);
    }
    function selectCustomerFromDropdown() {
      const v = customerDropdown.value;
      if (!v) return;
      activeCustomerId = v;
      persistAndRender();
    }
    function getOrCreateCustomerByName(name) {
      const found = customers.find(c => c.name.toLowerCase() === name.toLowerCase());
      if (found) { activeCustomerId = found.id; persistAndRender(); return found; }
      return createCustomer(name);
    }
    function quickCustomer(name) { getOrCreateCustomerByName(name); }

    /***********************
     * balance calculation: total items - payments + refunds
     ***********************/
    function unpaidTotalForCustomer(c) {
      const itemsTotal = (c.items || []).reduce((s, it) => s + Number(it.price) * Number(it.qty), 0);
      const payments = (c.adjustments || []).reduce((s, a) => s + (a.type === 'payment' ? Number(a.amount || 0) : 0), 0);
      const refunds = (c.adjustments || []).reduce((s, a) => s + (a.type === 'refund' ? Number(a.amount || 0) : 0), 0);
      return Math.round((itemsTotal - payments + refunds + Number.EPSILON) * 100) / 100;
    }

    function renderCustomerDropdown() {
      customerDropdown.innerHTML = '<option value="">— Select customer —</option>';
      customers.forEach(c => {
        const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name + (unpaidTotalForCustomer(c) ? (' • ₹' + unpaidTotalForCustomer(c)) : '');
        customerDropdown.appendChild(opt);
      });
      if (activeCustomerId) customerDropdown.value = activeCustomerId;
      updateQuickButtons();
    }

    function updateQuickButtons() {
      const btns = document.querySelectorAll('.quick-btn');
      btns.forEach(btn => {
        const name = btn.dataset.name;
        const found = customers.find(c => c.name.toLowerCase() === name.toLowerCase());
        btn.classList.toggle('active', !!found && found.id === activeCustomerId);
      });
    }

    /***********************
     * add item & item payment toggles (NEW robust logic)
     *
     * - When clicking an item to mark paid, we create a payment adjustment
     *   linked to that item (linkedItemId), so payments reflect actual money.
     * - When unpaying, we remove the linked payment adjustment.
     *
     ***********************/
    function addItemToActive(menuItem, qtyFromPanel) {
      const qty = Math.max(1, Number(typeof qtyFromPanel !== 'undefined' ? qtyFromPanel : (qtySidebar.value || 1)));
      if (!activeCustomerId) {
        const maybe = prompt('No active customer. Enter name for new customer or leave blank:', '');
        const c = createCustomer(maybe || '');
        activeCustomerId = c.id;
      }
      const cust = customers.find(c => c.id === activeCustomerId);
      if (!cust) { alert('Active customer missing'); return; }
      const it = { id: 'I-' + Date.now() + '-' + Math.floor(Math.random() * 900 + 100), name: menuItem.name, price: Number(menuItem.price), qty: qty, datetime: new Date().toISOString(), paid: false };
      cust.items.push(it); cust.uploaded = false; persistAndRender();
    }
    function quickAdd() { const defaultItem = MENU[0]; addItemToActive(defaultItem); }

    function createPaymentForItem(cust, it) {
      if (!cust || !it) return;
      cust.adjustments = cust.adjustments || [];
      const existing = cust.adjustments.find(a => a.type === 'payment' && a.linkedItemId === it.id);
      if (existing) return; // already paid via adjustment
      const adj = { id: genId('A'), type: 'payment', amount: Number(it.price) * Number(it.qty), note: 'item-paid', linkedItemId: it.id, datetime: new Date().toISOString() };
      cust.adjustments.push(adj);
    }
    function removeItemPaymentAdjustments(cust, itemId) {
      if (!cust || !cust.adjustments) return;
      cust.adjustments = cust.adjustments.filter(a => !(a.type === 'payment' && a.linkedItemId === itemId));
    }

    /***********************
     * adjustments UI for manual payments
     ***********************/
    function openAdjustSimple(customerId) {
      const cust = customers.find(c => c.id === customerId);
      if (!cust) return alert('Customer not found');
      const choice = prompt('Type 1 to RECORD cash received (customer paid). Type 2 to RECORD change/refund (we gave money).', '1');
      if (!choice) return;
      const mode = choice.trim() === '2' ? 'refund' : 'payment';
      const amtRaw = prompt(mode === 'payment' ? `Enter amount received from customer (numbers only).` : `Enter amount of change/refund given to customer.`, '');
      if (!amtRaw) return; const amount = Number(amtRaw);
      if (Number.isNaN(amount) || amount <= 0) return alert('Invalid amount');
      const note = prompt('Optional note (reason):', '');
      const adj = { id: 'A-' + Date.now() + '-' + Math.floor(Math.random() * 900 + 100), type: mode === 'payment' ? 'payment' : 'refund', amount, note: note || '', datetime: new Date().toISOString() };
      if (!Array.isArray(cust.adjustments)) cust.adjustments = [];
      cust.adjustments.push(adj);
      persistAndRender();
    }

    /***********************
     * render orders: item click toggles paid/unpaid and creates/removes per-item adjustments
     ***********************/
    function renderOrders() {
      ordersContainer.innerHTML = '';
      if (!activeCustomerId && customers.length) activeCustomerId = customers[0].id;
      customers.forEach(c => {
        if (!Array.isArray(c.adjustments)) c.adjustments = [];
        const card = document.createElement('div'); card.className = 'order-card';
        const left = document.createElement('div'); left.style.flex = '1';

        const itemsTotal = c.items.reduce((s, it) => s + Number(it.price) * Number(it.qty), 0);
        const balance = unpaidTotalForCustomer(c);

        left.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;">
        <div><strong>${c.name}</strong><div class="order-meta">ID:${c.id} • ${new Date(c.createdAt).toLocaleTimeString()}</div></div>
        <div style="text-align:right">
          <div class="muted">Total</div>
          <div><strong>₹${itemsTotal}</strong></div>
          <div style="margin-top:6px" id="badge-${c.id}">${balance > 0 ? `<span class="badge-due">Due ₹${balance}</span>` : (balance < 0 ? `<span style="background:var(--ok);padding:6px 10px;border-radius:8px;font-weight:700;color:#072033">We owe ₹${Math.abs(balance)}</span>` : `<span class="muted">Paid</span>`)}</div>
        </div>
      </div>`;

        const itemsWrap = document.createElement('div'); itemsWrap.className = 'items';
        c.items.forEach(it => {
          const r = document.createElement('div'); r.className = 'item-row' + (it.paid ? ' paid' : '');
          r.onclick = (e) => {
            e.stopPropagation();
            // toggle logic: if marking paid -> create payment adj linked to item; if unpay -> remove that linked adj
            if (!it.paid) {
              it.paid = true; it.paidAt = new Date().toISOString();
              createPaymentForItem(c, it);
            } else {
              it.paid = false; it.paidAt = null;
              removeItemPaymentAdjustments(c, it.id);
            }
            persistAndRender();
          };

          const delBtn = `<button class="btn small ghost" style="margin-left:8px;padding:6px;border-radius:6px;background:rgba(255,0,0,0.08);">Del</button>`;

          r.innerHTML = `<div style="display:flex;gap:8px;align-items:center;">
            <div style="font-weight:700">${it.name}${it.qty > 1 ? ` x${it.qty}` : ''}</div>
            <div class="muted" style="font-size:12px">${new Date(it.datetime).toLocaleTimeString()}</div>
          </div>
          <div style="min-width:110px;text-align:right;display:flex;align-items:center;justify-content:flex-end">
            <div style="margin-right:8px">₹${Number(it.price) * Number(it.qty)}</div>
            ${delBtn}
          </div>`;

          itemsWrap.appendChild(r);
          const btn = r.querySelector('button');
          btn.onclick = (e) => {
            e.stopPropagation(); if (!confirm('Delete this item from the order?')) return; const idx = c.items.findIndex(x => x.id === it.id); if (idx >= 0) c.items.splice(idx, 1); // also remove any linked payment adjustments
            removeItemPaymentAdjustments(c, it.id); persistAndRender();
          };
        });

        const adjWrap = document.createElement('div');
        if ((c.adjustments || []).length) {
          (c.adjustments || []).forEach(a => {
            const arow = document.createElement('div'); arow.style.display = 'flex'; arow.style.justifyContent = 'space-between'; arow.style.padding = '6px 8px'; arow.style.borderRadius = '8px'; arow.style.background = 'rgba(255,255,255,0.02)'; arow.style.fontSize = '13px';
            const label = a.type === 'payment' ? `Received: ₹${a.amount}` : `Change/refund: ₹${a.amount}`;
            arow.innerHTML = `<div style="font-weight:600">${label} ${a.note ? '— ' + a.note : ''}</div>
            <div style="min-width:60px;text-align:right"><small class="muted">${new Date(a.datetime).toLocaleTimeString()}</small> <button style="margin-left:8px" class="btn small ghost">Del</button></div>`;
            arow.querySelector('button').onclick = (e) => { e.stopPropagation(); if (confirm('Delete adjustment?')) { c.adjustments = (c.adjustments || []).filter(x => x.id !== a.id); persistAndRender(); } };
            adjWrap.appendChild(arow);
          });
        }

        left.appendChild(itemsWrap); left.appendChild(adjWrap);

        const right = document.createElement('div'); right.style.display = 'flex'; right.style.flexDirection = 'column'; right.style.gap = '8px';
        const btnAdjust = document.createElement('button'); btnAdjust.className = 'btn small ghost'; btnAdjust.textContent = 'Adjust'; btnAdjust.onclick = (e) => { e.stopPropagation(); openAdjustSimple(c.id); };

        const btn1 = document.createElement('button'); btn1.className = 'btn small ghost'; btn1.textContent = c.items.some(i => !i.paid) ? 'Mark All Paid' : 'Mark All Unpaid';
        btn1.onclick = (e) => {
          e.stopPropagation();
          // toggle behavior using per-item linked adjustments
          const unpaidItems = (c.items || []).filter(i => !i.paid);
          if (unpaidItems.length > 0) {
            // create payment adjustment per unpaid item and mark them paid
            unpaidItems.forEach(i => {
              i.paid = true; i.paidAt = new Date().toISOString();
              createPaymentForItem(c, i);
            });
          } else {
            // unmark all: remove any linked payment adjustments for these items, set paid = false
            const itemIds = (c.items || []).map(i => i.id);
            c.adjustments = (c.adjustments || []).filter(a => !(a.type === 'payment' && a.linkedItemId && itemIds.includes(a.linkedItemId)));
            (c.items || []).forEach(i => { i.paid = false; i.paidAt = null; });
          }
          persistAndRender();
        };

        const btn2 = document.createElement('button'); btn2.className = 'btn small'; btn2.textContent = 'Delete'; btn2.style.background = 'rgba(255,0,0,0.12)';
        btn2.onclick = (e) => { e.stopPropagation(); if (confirm('Delete customer and items?')) { customers = customers.filter(x => x.id !== c.id); if (activeCustomerId === c.id) activeCustomerId = customers.length ? customers[0].id : null; persistAndRender(); } };

        right.appendChild(btnAdjust); right.appendChild(btn1); right.appendChild(btn2);
        card.appendChild(left); card.appendChild(right);
        ordersContainer.appendChild(card);
      });

      const ac = customers.find(c => c.id === activeCustomerId);
      if (ac) {
        const bal = unpaidTotalForCustomer(ac);
        activeCustomerLabel.textContent = ac.name;
        activeCustomerIdLabel.textContent = ac.id;
        if (bal > 0) { dueBadge.style.background = 'var(--danger)'; dueBadge.textContent = '₹' + bal; }
        else if (bal < 0) { dueBadge.style.background = 'var(--ok)'; dueBadge.textContent = '₹' + Math.abs(bal); }
        else { dueBadge.style.background = 'var(--muted)'; dueBadge.textContent = '₹0'; }
      } else { activeCustomerLabel.textContent = '—'; activeCustomerIdLabel.textContent = ''; dueBadge.textContent = '₹0'; }

      pendingSummary.textContent = `${pendingBatches.length} pending upload batch(es)`;
      renderCustomerDropdown();
    }

    /***********************
     * Upload (Cloudflare worker proxy)
     ***********************/
    const UPLOAD_ENDPOINT = 'https://cafesales.avihs.workers.dev';
    const UPLOAD_API_KEY = 'k7T4K2Jd2w';

    function persistAndRender() {
      writeJSON(KEY_ORDERS, customers);
      writeJSON(KEY_PENDING, pendingBatches);
      renderOrders();
      updateQuickButtons();
    }

    function buildUploadBatch() {
      const toUpload = customers.filter(c => (c.items && c.items.length > 0) || (c.adjustments && c.adjustments.length > 0) && !c.uploaded);
      if (toUpload.length === 0) return null;
      const entries = [];
      toUpload.forEach(c => {
        (c.items || []).forEach(it => {
          entries.push({
            entryType: 'item',
            customerId: c.id,
            customerName: c.name,
            itemId: it.id,
            itemName: it.name,
            qty: it.qty,
            price: it.price,
            paid: !!it.paid,
            datetime: it.datetime
          });
        });
        (c.adjustments || []).forEach(adj => {
          entries.push({
            entryType: 'adjustment',
            adjustType: adj.type,
            customerId: c.id,
            customerName: c.name,
            itemId: adj.id,
            itemName: (adj.type === 'payment' ? 'PAYMENT' : 'CHARGE') + (adj.note ? (' — ' + adj.note) : ''),
            qty: 1,
            price: Number(adj.amount || 0),
            paid: true,
            datetime: adj.datetime
          });
        });
      });
      return { createdAt: new Date().toISOString(), entries, customers: toUpload.map(c => ({ id: c.id, name: c.name })) };
    }

    async function uploadPending(manual = false) {
      const batch = buildUploadBatch();
      if (!batch) { if (manual) alert('No new records to upload'); return; }
      pendingBatches.push(batch); writeJSON(KEY_PENDING, pendingBatches); renderOrders();

      while (pendingBatches.length) {
        const next = pendingBatches[0];
        try {
          const res = await fetch(UPLOAD_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-cafe-key': UPLOAD_API_KEY },
            body: JSON.stringify({ action: 'batch_upload', data: next })
          });

          const text = await res.text();
          let j;
          try { j = text ? JSON.parse(text) : {}; } catch (e) { j = { result: 'error', message: 'Invalid JSON from server', raw: text }; }

          if (j && j.result === 'success') {
            const affectedIds = (next.customers || []).map(x => x.id);
            customers.forEach(c => { if (affectedIds.includes(c.id)) c.uploaded = true; });
            pendingBatches.shift();
            writeJSON(KEY_PENDING, pendingBatches);
            writeJSON(KEY_ORDERS, customers);
            localStorage.setItem('cafe_last_upload_date_v1', new Date().toISOString());
            if (manual) alert('Upload successful.');
          } else {
            console.error('Upload rejected', j);
            if (manual) alert('Upload failed: ' + (j.message || 'server rejected'));
            break;
          }
        } catch (err) {
          console.error('Upload error', err);
          if (manual) alert('Upload failed: ' + err.message);
          break;
        }
      }
      renderOrders();
    }

    /***********************
     * CSV / XLSX export
     ***********************/
    function buildSalesRows() {
      const customersLocal = customers || [];
      const header = ['customerId', 'customerName', 'entryType', 'adjustType', 'itemId', 'itemName', 'qty', 'price', 'paid', 'datetime', 'uploaded', 'note'];
      const rows = [header];
      customersLocal.forEach(cust => {
        const uploaded = !!cust.uploaded;
        (cust.items || []).forEach(it => {
          rows.push([cust.id || '', cust.name || '', 'item', '', it.id || '', it.name || '', Number(it.qty || 1), Number(it.price || 0), it.paid ? 'TRUE' : 'FALSE', it.datetime || '', uploaded ? 'TRUE' : 'FALSE', '']);
        });
        (cust.adjustments || []).forEach(adj => {
          rows.push([cust.id || '', cust.name || '', 'adjustment', adj.type || '', adj.id || '', (adj.note ? (adj.type.toUpperCase() + ' — ' + adj.note) : (adj.type.toUpperCase())), 1, Number(adj.amount || 0), 'TRUE', adj.datetime || '', uploaded ? 'TRUE' : 'FALSE', adj.note || '']);
        });
      });
      return rows;
    }
    function downloadSalesCSV(filename = null) {
      const rows = buildSalesRows();
      if (rows.length <= 1) { alert('No sales data found to export.'); return; }
      const csv = rows.map(r => r.map(cell => { const s = (cell === null || cell === undefined) ? '' : String(cell); return `"${s.replace(/"/g, '""')}"`; }).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const name = filename || `cafe_sales_${(new Date()).toISOString().slice(0, 19).replace(/[:T]/g, '-')}.csv`;
      const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.setAttribute('download', name); document.body.appendChild(link); link.click(); link.remove(); URL.revokeObjectURL(link.href);
    }
    function downloadSalesXLSX(filename = null) {
      const rows = buildSalesRows();
      if (rows.length <= 1) { alert('No sales data found to export.'); return; }
      const ws = XLSX.utils.aoa_to_sheet(rows);
      ws['!cols'] = [{ wch: 20 }, { wch: 24 }, { wch: 20 }, { wch: 40 }, { wch: 6 }, { wch: 10 }, { wch: 8 }, { wch: 22 }, { wch: 8 }];
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Sales');
      const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([wbout], { type: 'application/octet-stream' });
      const name = filename || `cafe_sales_${(new Date()).toISOString().slice(0, 19).replace(/[:T]/g, '-')}.xlsx`;
      const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.setAttribute('download', name); document.body.appendChild(link); link.click(); link.remove(); URL.revokeObjectURL(link.href);
    }

    /***********************
     * misc helpers
     ***********************/
    function adjustQty(delta) { qtySidebar.value = Math.max(1, Number(qtySidebar.value || 1) + delta); }
    function openVisualizer() { window.location.href = 'salesvisual.html'; }

    /***********************
     * startup
     ***********************/
    (function init() {
      if (customers.length === 0) {
        const c = createCustomer(null); activeCustomerId = c.id;
      }
      renderCategories(); renderMenu(); renderCustomerDropdown(); renderOrders();
      document.addEventListener('keydown', (e) => { if (e.key === 'Enter') quickAdd(); });
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.0/dist/xlsx.full.min.js"></script>
</body>

</html>